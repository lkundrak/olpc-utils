#!/bin/bash
#
# Copyright (c) 2007 OLPC
# Author: galanis at laptop.org 
# Version 0.4
#
# this program is free software; you can redistribute it and/or modify
# it under the terms of the gnu general public license as published by
# the free software foundation; either version 2 of the license, or
# (at your option) any later version.
#
# this program is distributed in the hope that it will be useful,
# but without any warranty; without even the implied warranty of
# merchantability or fitness for a particular purpose.  see the
# gnu general public license for more details.
#
# you should have received a copy of the gnu general public license
# along with this program; if not, write to the free software
# foundation, inc., 51 franklin st, fifth floor, boston, ma  02110-1301  usa

function info {
model=`cat /ofw/model`
serial=`cat /ofw/serial-number`
build=`cat /boot/olpc_build`
fw=`cat /ofw/openprom/model`
libertas=`ethtool -i eth0|grep firmware|awk '{print $2}'`
echo
echo 'Model     : '$model
echo 'Serial    : '$serial
echo
echo 'Build     : '$build
echo 'Firmware  : '$fw
echo 'Libertas  : '$libertas

}

function net {

#nick
i=$(cat /home/olpc/.sugar/default/config|grep nick)
nick=${i:11}
echo ''
echo 'Nick      : '$nick

#mac
mac=''
mac=$(ifconfig|grep eth0|awk '{print $5}'|tr '[A-F]' '[a-f]')
echo 'MAC       : '$mac
echo ''

#ip
for i in `ifconfig|grep HWaddr|awk '{print $1}'`
do
	echo -n "IP $i   : "
	echo `ifconfig $i|grep "inet addr"|awk 'BEGIN{FS="addr:"}{print $2}'|awk '{print $1}'` 
done

#nameserver
dns=''
while read line
do
	i=$(echo $line | grep nameserver)
	if [ ${#i} -ne 0 ]; then dns=${line:11};fi
done < <(cat /etc/resolv.conf)
echo 'DNS       : '$dns
echo ''


#telepathy
i=0
while read line
do 
	tele=$(basename $line|tr '-' ' '|awk '{print $2}')
	if [ $i -eq 0 ]; then echo 'Telepathy : '$tele
	else echo '            '$tele;fi
	((i=i+1))
done< <(ps U olpc|grep telepathy|awk '{print $5}')


#jabber
jabber=''
jabber=`netstat -tpT --numeric-ports 2> /dev/null|grep telepathy|grep ESTABLISHED|awk '{print $5}'|awk 'BEGIN{FS=":522"}{print $1}'`
echo 'Jabber    : '$jabber
echo ''

#essid
essid=''
essid=`iwconfig eth0|grep ESSID|awk 'BEGIN{FS="ESSID:\""}{print $2}'|awk 'BEGIN{FS="\""}{print $1}'`
echo 'Essid     : '$essid


#channel
ch=''
freq=`iwconfig eth0|grep Freq|grep -v eth0|awk 'BEGIN{FS="uency:"}{print $2}'|awk '{print $1}'`
[ "$freq" = 2.412 ] && ch=1
[ "$freq" = 2.437 ] && ch=6
[ "$freq" = 2.462 ] && ch=11

echo 'Channel   : '$ch
echo ''

#ethernet
ethernet=''
for i in `ifconfig|grep HWaddr|awk '{print $1}'`
do
	iwconfig $i 2>&1|grep "no wireless" > /dev/null && ethernet="$i $ethernet"
done

#config
eth=''
msh=''
ipeth=''
ipmsh=''

for i in `ifconfig|grep HWaddr|grep ^eth|awk '{print $1}'`
do
	ifconfig $i|grep "inet addr" > /dev/null && eth=$i
done

for i in `ifconfig|grep HWaddr|grep ^msh|awk '{print $1}'`
do
	ifconfig $i 2>&1|grep "inet addr" > /dev/null && msh=$i
done

[ -n "$eth" ] && ipeth=`ifconfig $eth|grep "inet addr"|awk 'BEGIN{FS="addr:"}{print $2}'|awk '{print $1}'`
[ -n "$msh" ] && ipmsh=`ifconfig $msh|grep "inet addr"|awk 'BEGIN{FS="addr:"}{print $2}'|awk '{print $1}'`

config=''
if [ ${#ipeth} -ne 0 ]
then 
	echo $ethernet|grep $eth > /dev/null && config="Ethernet"
	echo $ethernet|grep $eth > /dev/null || config="Access point"
elif [ ${#dns} -eq 0 ]
then
	config='Link-local'
elif [ "${ipmsh:0:3}" = "169" ]
then
	config='MPP'
else config='School server'
fi	
[ ${#ipmsh} -eq 0 ] && [ ! "$config" = "Ethernet" ] && config=""


#acting as MPP
asmpp='' 
[ -n "$ipmsh" ] && cat /etc/dhcpd.conf 2>&1|grep "$ipmsh" > /dev/null && asmpp=' - Acting as MPP'

echo "Ethernet  : $ethernet"
echo "Config    : $config$asmpp"
echo ''
}

function help {

echo "Usage: olpc-netstatus [-i|-n]"
echo
echo "  -i     device info only"
echo "  -n     network info only"
echo
}

if [ "$1" = "-i" ];then info;echo
elif [ "$1" = "-n" ];then net
elif [ -n "$1" ];then help;
else info;net
fi 
